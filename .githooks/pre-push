#!/usr/bin/env bash
set -euo pipefail

# Validate commit subjects before push using the same checker as CI.

repo_root="$(git rev-parse --show-toplevel)"
checker="${repo_root}/scripts/check-commit-messages.sh"

if [ ! -x "${checker}" ]; then
  echo "pre-push: missing executable checker at ${checker}" >&2
  exit 1
fi

zero40="0000000000000000000000000000000000000000"
validated_any=0

while read -r local_ref local_sha remote_ref remote_sha; do
  if [[ -z "${local_ref:-}" ]]; then
    continue
  fi
  if [[ "${local_sha}" == "${zero40}" ]]; then
    continue
  fi

  if [[ "${remote_sha}" == "${zero40}" ]]; then
    # New branch/tag push: bounded window fallback.
    range="${local_sha}~50..${local_sha}"
  else
    range="${remote_sha}..${local_sha}"
  fi

  echo "pre-push: validating commit subjects for ${local_ref} -> ${remote_ref} (${range})"
  "${checker}" "${range}"
  validated_any=1
done

if [[ "${validated_any}" -eq 0 ]]; then
  echo "pre-push: no commits to validate."
fi

exit 0
