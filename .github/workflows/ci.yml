name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    env:
      LIBTORCH_VERSION: 2.9.1
      MACOSX_DEPLOYMENT_TARGET: 14.0
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-22.04]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install elan
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Set up Lean toolchain
        run: |
          elan toolchain install $(cat lean-toolchain)
          elan default $(cat lean-toolchain)

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install libomp apache-arrow libsoxr

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates lsb-release wget
          codename="$(lsb_release --codename --short)"
          arrow_repo_pkg="apache-arrow-apt-source-latest-${codename}.deb"
          wget "https://packages.apache.org/artifactory/arrow/ubuntu/${arrow_repo_pkg}"
          sudo apt-get install -y -V "./${arrow_repo_pkg}"
          rm -f "${arrow_repo_pkg}"
          sudo apt-get update
          sudo apt-get install -y libomp-dev libarrow-dev libparquet-dev libsoxr-dev unzip

      - name: Cache LibTorch
        id: cache-libtorch
        uses: actions/cache@v4
        with:
          path: external/libtorch
          key: libtorch-${{ runner.os }}-${{ runner.arch }}-${{ env.LIBTORCH_VERSION }}

      - name: Download LibTorch
        if: steps.cache-libtorch.outputs.cache-hit != 'true'
        run: |
          mkdir -p external
          if [ "${{ runner.os }}" = "macOS" ]; then
            if [ "${{ runner.arch }}" = "ARM64" ]; then
              LIBTORCH_URL="https://download.pytorch.org/libtorch/cpu/libtorch-macos-arm64-${LIBTORCH_VERSION}.zip"
            else
              LIBTORCH_URL="https://download.pytorch.org/libtorch/cpu/libtorch-macos-x86_64-${LIBTORCH_VERSION}.zip"
            fi
          else
            LIBTORCH_URL="https://download.pytorch.org/libtorch/cpu/libtorch-shared-with-deps-${LIBTORCH_VERSION}%2Bcpu.zip"
          fi
          echo "Downloading ${LIBTORCH_URL}"
          curl --fail --location --retry 5 --retry-all-errors --show-error -o libtorch.zip "${LIBTORCH_URL}"
          unzip -tq libtorch.zip
          unzip -q libtorch.zip -d external/
          rm libtorch.zip

      - name: Verify LibTorch version
        run: |
          cfg="external/libtorch/share/cmake/Torch/TorchConfigVersion.cmake"
          test -f "${cfg}"
          grep -F "set(PACKAGE_VERSION \"${LIBTORCH_VERSION}\")" "${cfg}"

      - name: Build required test runners
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            lean_prefix="$(lean --print-prefix)"
            multiarch_dir="/usr/lib/$(gcc -print-multiarch)"
            gomp_dir="$(dirname "$(gcc -print-file-name=libgomp.so)")"
            export LEAN_CC="$PWD/scripts/lean_cc_wrapper.sh"
            export LEAN_CC_GCC="/usr/bin/gcc"
            export LIBRARY_PATH="${multiarch_dir}:${gomp_dir}:/usr/lib:${LIBRARY_PATH:-}"
            export LD_LIBRARY_PATH="$PWD/external/libtorch/lib:${lean_prefix}/lib:${lean_prefix}/lib/glibc:${multiarch_dir}:${gomp_dir}:/usr/lib:${LD_LIBRARY_PATH:-}"
          fi
          lake build test_runner test_runner_experimental

      - name: Typecheck required example surfaces
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            lean_prefix="$(lean --print-prefix)"
            multiarch_dir="/usr/lib/$(gcc -print-multiarch)"
            gomp_dir="$(dirname "$(gcc -print-file-name=libgomp.so)")"
            export LEAN_CC="$PWD/scripts/lean_cc_wrapper.sh"
            export LEAN_CC_GCC="/usr/bin/gcc"
            export LIBRARY_PATH="${multiarch_dir}:${gomp_dir}:/usr/lib:${LIBRARY_PATH:-}"
            export LD_LIBRARY_PATH="$PWD/external/libtorch/lib:${lean_prefix}/lib:${lean_prefix}/lib/glibc:${multiarch_dir}:${gomp_dir}:/usr/lib:${LD_LIBRARY_PATH:-}"
          fi
          lake -R build Examples
          # Key example files that are not covered by `Examples.lean`.
          lake -R env lean Examples/NanoChat/Generator/TypedState.lean
          lake -R env lean Examples/BranchingFlows/BranchingFlowsDemo.lean
          lake -R env lean Examples/NanoProof/RLTrain.lean

      - name: Run tests
        run: |
          lean_prefix="$(lean --print-prefix)"
          LEAN_LIB="${lean_prefix}/lib/lean"
          if [ "${{ runner.os }}" = "macOS" ]; then
            export DYLD_LIBRARY_PATH="$PWD/external/libtorch/lib:/opt/homebrew/opt/libomp/lib:$LEAN_LIB"
          else
            multiarch_dir="/usr/lib/$(gcc -print-multiarch)"
            gomp_dir="$(dirname "$(gcc -print-file-name=libgomp.so)")"
            export LEAN_CC="$PWD/scripts/lean_cc_wrapper.sh"
            export LEAN_CC_GCC="/usr/bin/gcc"
            export LD_LIBRARY_PATH="$PWD/external/libtorch/lib:${lean_prefix}/lib:${lean_prefix}/lib/glibc:${multiarch_dir}:${gomp_dir}:/usr/lib:$LEAN_LIB"
          fi
          lake env ./.lake/build/bin/test_runner --fail-fast

      - name: Run experimental tests
        run: |
          lean_prefix="$(lean --print-prefix)"
          LEAN_LIB="${lean_prefix}/lib/lean"
          if [ "${{ runner.os }}" = "macOS" ]; then
            export DYLD_LIBRARY_PATH="$PWD/external/libtorch/lib:/opt/homebrew/opt/libomp/lib:$LEAN_LIB"
          else
            multiarch_dir="/usr/lib/$(gcc -print-multiarch)"
            gomp_dir="$(dirname "$(gcc -print-file-name=libgomp.so)")"
            export LEAN_CC="$PWD/scripts/lean_cc_wrapper.sh"
            export LEAN_CC_GCC="/usr/bin/gcc"
            export LD_LIBRARY_PATH="$PWD/external/libtorch/lib:${lean_prefix}/lib:${lean_prefix}/lib/glibc:${multiarch_dir}:${gomp_dir}:/usr/lib:$LEAN_LIB"
          fi
          lake env ./.lake/build/bin/test_runner_experimental

      - name: Evaluate Qwen3-TTS parity regression gate
        if: runner.os == 'macOS'
        id: qwen3tts-parity-gate
        run: |
          set +e
          ./scripts/qwen3tts_parity_regression.sh --check-prereqs
          status=$?
          set -e
          case "$status" in
            0)
              echo "status=ready" >> "$GITHUB_OUTPUT"
              ;;
            2)
              echo "status=skip" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "[qwen3tts-parity] FAIL: prerequisite check exited with status $status"
              exit "$status"
              ;;
          esac

      - name: Run Qwen3-TTS parity regression
        if: runner.os == 'macOS' && steps.qwen3tts-parity-gate.outputs.status == 'ready'
        run: ./scripts/qwen3tts_parity_regression.sh

      - name: Record Qwen3-TTS parity regression skip
        if: runner.os == 'macOS' && steps.qwen3tts-parity-gate.outputs.status == 'skip'
        run: echo "[qwen3tts-parity] skipped due to missing optional prerequisites"

      - name: Evaluate Qwen3-TTS ASR regression gate
        if: runner.os == 'macOS'
        id: qwen3tts-asr-gate
        run: |
          set +e
          ./scripts/qwen3tts_asr_regression.sh --check-prereqs
          status=$?
          set -e
          case "$status" in
            0)
              echo "status=ready" >> "$GITHUB_OUTPUT"
              ;;
            2)
              echo "status=skip" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "[qwen3tts-asr] FAIL: prerequisite check exited with status $status"
              exit "$status"
              ;;
          esac

      - name: Run Qwen3-TTS ASR audio regression
        if: runner.os == 'macOS' && steps.qwen3tts-asr-gate.outputs.status == 'ready'
        run: ./scripts/qwen3tts_asr_regression.sh

      - name: Record Qwen3-TTS ASR regression skip
        if: runner.os == 'macOS' && steps.qwen3tts-asr-gate.outputs.status == 'skip'
        run: echo "[qwen3tts-asr] skipped due to missing optional prerequisites"

  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit subject format
        run: |
          set -euo pipefail
          zero40="0000000000000000000000000000000000000000"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base="${{ github.event.pull_request.base.sha }}"
            head="${{ github.event.pull_request.head.sha }}"
          else
            base="${{ github.event.before }}"
            head="${{ github.sha }}"
          fi
          if [ -z "${base}" ] || [ "${base}" = "${zero40}" ]; then
            echo "No base SHA available; validating full ancestry of ${head}"
            mapfile -t commits < <(git rev-list --reverse "${head}")
          else
            echo "Validating commits in ${base}..${head}"
            mapfile -t commits < <(git rev-list --reverse "${base}..${head}")
          fi
          if [ "${#commits[@]}" -eq 0 ]; then
            echo "No commits to validate."
            exit 0
          fi
          for commit in "${commits[@]}"; do
            ./scripts/check-commit-messages.sh "${commit}^!"
          done

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for TODO/FIXME comments..."
          if rg -n "(--|/-).*\\b(TODO|FIXME)\\b" Tyr/ Examples/ Tests/ -g "*.lean"; then
            echo "Found TODO/FIXME comments in Lean sources"
          else
            echo "No TODO/FIXME found"
          fi

      - name: Check Lake/Bazel target parity
        run: ./scripts/check_target_parity.sh

      - name: Check for sorry
        run: |
          echo "Checking for sorry (incomplete proofs)..."
          if rg -n "\\bsorry\\b" Tyr/ Examples/ Tests/ -g "*.lean" -g "!Tyr/Tokenizer/SpecialTokens.lean"; then
            echo "Found sorry in Lean sources"
          else
            echo "No sorry found"
          fi
