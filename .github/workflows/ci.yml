name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    env:
      LIBTORCH_VERSION: 2.7.1
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install elan
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Set up Lean toolchain
        run: |
          elan toolchain install $(cat lean-toolchain)
          elan default $(cat lean-toolchain)

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install libomp apache-arrow

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates lsb-release wget
          distro="$(lsb_release --id --short | tr 'A-Z' 'a-z')"
          codename="$(lsb_release --codename --short)"
          arrow_repo_pkg="apache-arrow-apt-source-latest-${distro}${codename}.deb"
          wget "https://packages.apache.org/artifactory/arrow/${distro}/${arrow_repo_pkg}"
          sudo apt-get install -y "./${arrow_repo_pkg}"
          rm -f "${arrow_repo_pkg}"
          sudo apt-get update
          sudo apt-get install -y libomp-dev libarrow-dev libparquet-dev unzip

      - name: Cache LibTorch
        id: cache-libtorch
        uses: actions/cache@v4
        with:
          path: external/libtorch
          key: libtorch-${{ runner.os }}-${{ env.LIBTORCH_VERSION }}

      - name: Download LibTorch
        if: steps.cache-libtorch.outputs.cache-hit != 'true'
        run: |
          mkdir -p external
          if [ "${{ runner.os }}" = "macOS" ]; then
            LIBTORCH_URL="https://download.pytorch.org/libtorch/cpu/libtorch-macos-arm64-${LIBTORCH_VERSION}.zip"
          else
            LIBTORCH_URL="https://download.pytorch.org/libtorch/cpu/libtorch-cxx11-abi-shared-with-deps-${LIBTORCH_VERSION}%2Bcpu.zip"
          fi
          echo "Downloading ${LIBTORCH_URL}"
          curl --fail --location --retry 5 --retry-all-errors --show-error -o libtorch.zip "${LIBTORCH_URL}"
          unzip -tq libtorch.zip
          unzip -q libtorch.zip -d external/
          rm libtorch.zip

      - name: Build test runner
        run: lake build test_runner

      - name: Run tests
        run: |
          LEAN_LIB="$(lean --print-prefix)/lib/lean"
          if [ "${{ runner.os }}" = "macOS" ]; then
            export DYLD_LIBRARY_PATH="$PWD/external/libtorch/lib:/opt/homebrew/opt/libomp/lib:$LEAN_LIB"
          else
            export LD_LIBRARY_PATH="$PWD/external/libtorch/lib:/usr/lib:$LEAN_LIB"
          fi
          lake env ./.lake/build/bin/test_runner --fail-fast

  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for TODO/FIXME comments..."
          rg -n "TODO|FIXME" Tyr/ -g "*.lean" || echo "No TODO/FIXME found"

      - name: Check Lake/Bazel target parity
        run: ./scripts/check_target_parity.sh

      - name: Check for sorry
        run: |
          echo "Checking for sorry (incomplete proofs)..."
          rg -n "sorry" Tyr/ -g "*.lean" || echo "No sorry found"
