name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    env:
      LIBTORCH_VERSION: 2.7.1
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-22.04]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install elan
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Set up Lean toolchain
        run: |
          elan toolchain install $(cat lean-toolchain)
          elan default $(cat lean-toolchain)

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install libomp apache-arrow

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates lsb-release wget
          codename="$(lsb_release --codename --short)"
          arrow_repo_pkg="apache-arrow-apt-source-latest-${codename}.deb"
          wget "https://packages.apache.org/artifactory/arrow/ubuntu/${arrow_repo_pkg}"
          sudo apt-get install -y -V "./${arrow_repo_pkg}"
          rm -f "${arrow_repo_pkg}"
          sudo apt-get update
          sudo apt-get install -y libomp-dev libarrow-dev libparquet-dev unzip

      - name: Cache LibTorch
        id: cache-libtorch
        uses: actions/cache@v4
        with:
          path: external/libtorch
          key: libtorch-${{ runner.os }}-${{ env.LIBTORCH_VERSION }}

      - name: Download LibTorch
        if: steps.cache-libtorch.outputs.cache-hit != 'true'
        run: |
          mkdir -p external
          if [ "${{ runner.os }}" = "macOS" ]; then
            LIBTORCH_URL="https://download.pytorch.org/libtorch/cpu/libtorch-macos-arm64-${LIBTORCH_VERSION}.zip"
          else
            LIBTORCH_URL="https://download.pytorch.org/libtorch/cpu/libtorch-cxx11-abi-shared-with-deps-${LIBTORCH_VERSION}%2Bcpu.zip"
          fi
          echo "Downloading ${LIBTORCH_URL}"
          curl --fail --location --retry 5 --retry-all-errors --show-error -o libtorch.zip "${LIBTORCH_URL}"
          unzip -tq libtorch.zip
          unzip -q libtorch.zip -d external/
          rm libtorch.zip

      - name: Build test modules
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            lean_prefix="$(lean --print-prefix)"
            multiarch_dir="/usr/lib/$(gcc -print-multiarch)"
            gomp_dir="$(dirname "$(gcc -print-file-name=libgomp.so)")"
            export LIBRARY_PATH="${multiarch_dir}:${gomp_dir}:/usr/lib:${LIBRARY_PATH:-}"
            export LD_LIBRARY_PATH="${lean_prefix}/lib:${lean_prefix}/lib/glibc:${multiarch_dir}:${gomp_dir}:/usr/lib:${LD_LIBRARY_PATH:-}"
          fi
          lake build Tests.RunTests

      - name: Run tests
        run: |
          lean_prefix="$(lean --print-prefix)"
          LEAN_LIB="${lean_prefix}/lib/lean"
          if [ "${{ runner.os }}" = "macOS" ]; then
            export DYLD_LIBRARY_PATH="$PWD/external/libtorch/lib:/opt/homebrew/opt/libomp/lib:$LEAN_LIB"
          else
            multiarch_dir="/usr/lib/$(gcc -print-multiarch)"
            gomp_dir="$(dirname "$(gcc -print-file-name=libgomp.so)")"
            export LD_LIBRARY_PATH="$PWD/external/libtorch/lib:${lean_prefix}/lib:${lean_prefix}/lib/glibc:${multiarch_dir}:${gomp_dir}:/usr/lib:$LEAN_LIB"
          fi
          lake env lean --run Tests/RunTests.lean --fail-fast

      - name: Set up Bazelisk
        if: runner.os == 'Linux'
        uses: bazelbuild/setup-bazelisk@v3

      - name: Build Bazel targets
        if: runner.os == 'Linux'
        run: bazel build //...

  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for TODO/FIXME comments..."
          rg -n "TODO|FIXME" Tyr/ -g "*.lean" || echo "No TODO/FIXME found"

      - name: Check Lake/Bazel target parity
        run: ./scripts/check_target_parity.sh

      - name: Check for sorry
        run: |
          echo "Checking for sorry (incomplete proofs)..."
          rg -n "sorry" Tyr/ -g "*.lean" || echo "No sorry found"
